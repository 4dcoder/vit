# (No change - efficient base image)
FROM nvidia/cuda:11.1.1-cudnn8-runtime-ubuntu20.04

# ... (user/group setup) ...

# System dependencies: GOOD - combined, then cleaned
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        git \
        software-properties-common \
        build-essential \
        gcc \
        g++ \
        make \
        libgl1-mesa-glx \
        libegl1-mesa \
        libxrandr2 \
        libxss1 \
        libxcursor1 \
        libxtst6 \
        libnss3 \
        libasound2 \
    && apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Python 3.10 installation: GOOD - combined, then cleaned
RUN add-apt-repository -y ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        python3.10-venv \
        libpython3.10-dev \
    && apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Venv setup, PATH, PYTHONUNBUFFERED, pip upgrade: GOOD
RUN python3.10 -m venv /venv
ENV PATH="/venv/bin:$PATH"
ENV PYTHONUNBUFFERED 1
RUN pip install pip --upgrade

# Working directory setup: GOOD
WORKDIR /usr/src/app

# Copy requirements.txt: GOOD - this leverages cache
COPY requirements.txt .

# Install Python dependencies: GOOD - uses --no-cache-dir
RUN pip install --no-cache-dir -r requirements.txt

# Copy remaining project code: GOOD - this is done LATE, so changes in code
# don't invalidate earlier layers (like system/Python installs).
COPY . .

# ... (user setup, ENTRYPOINT) ...